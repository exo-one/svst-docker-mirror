# When adding things that need to be changed for testing, remember
# to update bin/2_modify_docker_test.py
#
# e.g. running bitcoind in regtest mode
#      or adding environment variables

version: '2.1'

services:
  bitcoind:
    build:
      context: ./docker-bitcoind/
    entrypoint: "sh -c 'btc_init && bitcoind'"
    env_file:
      - env_vars.env
    volumes:
      - ./bitcoind-data:/bitcoin
    expose:
      - "8332"

  ipfs:
    depends_on:
      - "bitcoind"
    image: "jbenet/go-ipfs"
    ports:
      - "4001:4001"
    volumes:
      - ./ipfs-data:/ipfs-data

  postgres:
    depends_on:
      - "ipfs"
    build:
      context: './dockerfiles/postgres/'
    env_file:
      - env_vars.env
    volumes:
      - ./postgres-data:/postgres-data

  scraper:  # haskell
    depends_on:
      - "postgres"
    build:
      context: .
      dockerfile: Dockerfile.scraper
    entrypoint: "scraper"

  producer:  # haskell & python
    depends_on:
      - "scraper"
    build:
      context: .
      dockerfile: Dockerfile.producer
    entrypoint: "sh -c './producer-production.sh'"
    env_file:
      - env_vars.env
    environment:
      - VERIFY_SECRET_KEY
      - VERIFY_PUBKEY

  header-download:  # python
    depends_on:
      - "scraper"
    build:
      context: .
      dockerfile: Dockerfile.header-download
    env_file:
      - env_vars.env
    entrypoint: "python3 ./header-download.py"

  pallet-download:  # python
    depends_on:
      - "scraper"
    build:
      context: .
      dockerfile: Dockerfile.pallet-download

  pallet-verifier:  # haskell
    depends_on:
      - "scraper"
    build:
      context: .
      dockerfile: Dockerfile.pallet-verifier

  state-maker:  # python
    depends_on:
      - "scraper"
    build:
      context: .
      dockerfile: Dockerfile.state-maker

  vote-explorer:  # python
    depends_on:
      - "state-maker"
    build:
      context: .
      dockerfile: Dockerfile.vote-explorer
    ports:
      - "127.0.0.1:8683:80"
